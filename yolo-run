#!/bin/bash
set -e

# --- 입력 확인 ---
if [ -z "$1" ]; then
  echo "Usage: yolo-run <image-path-or-URL>"
  exit 1
fi

INPUT="$1"
WORKDIR=/darknet          # Darknet 설치 경로
DATA_DIR=/data            # 결과/로그 저장 폴더 (컨테이너 내부)
HOST_DIR=/host_data       # 호스트와 마운트된 경로 (docker run -v <호스트경로>:/host_data)

# --- 결과/로그 폴더 자동 생성 ---
mkdir -p "$DATA_DIR"
mkdir -p "$HOST_DIR"

# --- 입력 이미지 처리 ---
if [[ "$INPUT" =~ ^https?:// ]]; then
  TMPIMG="$DATA_DIR/input.jpg"
  echo "Downloading image from $INPUT ..."
  wget --no-check-certificate -q -O "$TMPIMG" "$INPUT" || { echo "download fail"; exit 2; }
else
  if [ -f "$INPUT" ]; then
    TMPIMG="$INPUT"
  else
    echo "File not found: $INPUT"
    exit 3
  fi
fi

# --- YOLO 가중치 준비 ---
WEIGHTS="$WORKDIR/yolov3.weights"
if [ ! -f "$WEIGHTS" ]; then
  echo "Downloading yolov3.weights..."
  wget -q -O "$WEIGHTS" https://pjreddie.com/media/files/yolov3.weights \
    || { echo "weights download failed"; exit 4; }
fi

# --- YOLO 실행 ---
cd "$WORKDIR"

echo "Running YOLOv3 on $(basename "$TMPIMG") ..."
LOGFILE="$DATA_DIR/$(basename "$TMPIMG")_log.txt"

./darknet detector test cfg/coco.data cfg/yolov3.cfg "$WEIGHTS" "$TMPIMG" \
  -dont_show -ext_output | \
  awk -v img="$(basename "$TMPIMG")" '/Predicted in/ {printf "%s: Predicted in %.3f seconds\n", img, $4/1000; next} {print}' | tee "$LOGFILE"

# --- 결과 이미지 자동 복사 (컨테이너 내부 /data와 호스트 모두) ---
OUTPUT="$WORKDIR/predictions.jpg"
if [ -f "$OUTPUT" ]; then
  # 컨테이너 내부 /data
  cp "$OUTPUT" "$DATA_DIR/predictions.jpg"

  # 호스트 마운트 폴더
  cp "$OUTPUT" "$HOST_DIR/predictions.jpg"

  echo "Result saved to $DATA_DIR/predictions.jpg and also copied to host at $HOST_DIR/predictions.jpg"
else
  echo "predictions.jpg not found"
  exit 5
fi
